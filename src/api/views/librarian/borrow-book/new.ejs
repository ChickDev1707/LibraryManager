<%- contentFor('head') %> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<script src ="../../../../public/js/borrow-book.js"></script>
<%- contentFor('body') %> 
<%- include('../../partials/header/librarian-header.ejs') %> 

<div  class="container d-flex flex-column justify-content-center mw-100 mh-100" id="mainContainer"> 
    <div 
        class="position-absolute top-0 end-0 mt-3 me-3 w-20 d-flex flex-column" 
        id="alert_container" 
        style="z-index: 100; max-width: 25%; max-height: 90%;"
    >   
        <% if (status.alert) { %>
            <div class="alert alert-<%= status.type %>  alert-dismissible fade show" role="alert">
                <strong><%= status.message %> !</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <% } %>
    </div>
    <form 
        class="container search-container mb-3"
        action="/librarian/borrow" 
    >
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <select class="form-select form-control" name="search_option" id="search-option">
                    <option value="id" <%=option=="id"?"selected":"" %>  > 
                        ID
                    </option>
                    <option value="email" <%=option=="email"?"selected":"" %>> 
                        Email 
                    </option>
                </select>
            </div>
            <input 
                name="search_string"
                id="search_string"  
                type="text" 
                class="form-control text-truncate"
                value="<%=searchString %>"
                required 
            />
            <button class="btn btn-primary" type="submit">Tìm kiếm</button>
        </div>
    </form>

    <div class="container reader-container mb-3">
        <div class="row justify-content-center mb-1">
            <h5 class="text-center">Thông tin độc giả</h5>
        </div>
        <div class="row">
            <div class="col input-group mb-3">
                <span class="input-group-text" id="basic-addon1">
                    ID:
                </span>
                <input 
                    name="reader_id" 
                    id="reader_id"  
                    type="text" 
                    class="form-control text-truncate"
                    value="<%= reader?reader._id:'' %>"
                    disabled 
                />
            </div>
            <div class="col input-group mb-3">
                <span class="input-group-text" id="basic-addon1">
                    Email:
                </span>
                <input 
                    name="email" 
                    id="email"  
                    type="email" 
                    class="form-control text-truncate"
                    value="<%= reader?reader.email:'' %>" 
                    disabled 
                />
            </div>
        </div>
        <div class="row">
            <div class="col input-group mb-3">
                <span class="input-group-text" id="basic-addon1">
                    Họ và Tên:
                </span>
                <input 
                    name="ho_ten" 
                    id="ho_ten"  
                    type="text" 
                    class="form-control text-truncate"
                    value="<%= reader?reader.ho_ten:'' %>"
                    disabled 
                />
            </div>
            <div class="col input-group mb-3">
                <span class="input-group-text" id="basic-addon1">
                    Ngày sinh
                </span>
                <input 
                    name="ngay_sinh" 
                    id="ngay_sinh"  
                    type="text" 
                    class="form-control text-truncate"
                    value="<%= reader?reader.ngay_sinh:'' %>" 
                    disabled 
                />
            </div>
        </div>
        <div class="row">
            <div class="col input-group mb-3">
                <span class="input-group-text" id="basic-addon1">
                    Tiền nợ
                </span>
                <input 
                    name="tien_no" 
                    id="tien_no"  
                    type="number" 
                    class="form-control text-truncate"
                    value="<%= reader?reader.tien_no:'' %>"
                    disabled 
                />
            </div>
            <form  
                action="/librarian/borrow" 
                class="col input-group mb-3" 
                id="submit_form" 
                method="post"
            >
                <span class="input-group-text" id="basic-addon1">
                    Ngày mượn
                </span>
                <input 
                    name="ngay_muon" 
                    id="ngay_muon"  
                    type="date" 
                    class="form-control text-truncate"
                    value ="<%= new Date(Date.now()).toLocaleDateString('en-GB').split('/').reverse().join('-') %>"
                />

                <input 
                        name="ma_doc_gia"
                        id="ma_doc_gia"  
                        type="text" 
                        class="d-none"
                        value="<%= reader?reader._id:'' %>" 
                        required
                />
            </form>
        </div>
    </div>

    <div class="container">
        <div class="row justify-content-center mb-1">
            <h5 class="text-center">Danh sách sách đăng ký</h5>
        </div>
        <table class="table align-middle text-center table-striped" id="borrow_table">
            <thead class="table-dark">
                <tr>
                    <th scope="col">Ảnh bìa</th>
                    <th scope="col">Mã sách</th>
                    <th scope="col">Tên đầu sách</th>
                    <th scope="col">Giá</th>
                    <th scope="col">xoá</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th scope="col" colspan="5">
                        <button type="button" data-bs-toggle="modal" data-bs-target="#myModal" <%= reader?"":"disabled" %>  class="btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"></path>
                            </svg>
                        </button>
                    </th>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="d-flex flex-row justify-content-center">
        <button class="btn btn-primary btn-large" onclick="submit()"  <%= reader?"":"disabled" %>>Tạo phiếu mượn</button>
    </div> 
    <div class="modal fade " id="myModal" role="dialog" tabindex="-1">
        <div class="modal-dialog modal-xl modal-fullscreen-lg-down modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <select class="form-select form-control" name="search_book_option" id="search-book-option">
                                <option value="cahai" > 
                                    Cả hai
                                </option>
                                <option value="masach" > 
                                    Mã sách
                                </option>
                                <option value="tensach"> 
                                    Tên sách 
                                </option>
                            </select>
                        </div>
                        <input 
                            name="search_book_string"
                            id="search_book_string"  
                            type="text" 
                            class="form-control text-truncate"
                            value=""
                            required 
                        />
                        <button class="btn btn-primary" type="button" onclick="search()">Tìm kiếm</button>
                    </div>
                    
                    <table class="table align-middle text-center table-striped position-relative" id="add_table">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">Ảnh bìa</th>
                                <th scope="col">Mã sách</th>
                                <th scope="col">Tên đầu sách</th>
                                <th scope="col">Giá</th>
                                <th scope="col">Tình trạng</th> 
                                <th></th>
                            </tr>
                        </thead>
                        
                        <tbody>
                            <% if (books) { %>
                                <% books.forEach(book => { %>
                                    <tr masach="<%= book._id %>" tensach="<%= book.ten_dau_sach %>">  
                                        <td scope="col" >
                                            <a  
                                            href="books/<%= book._id %>"
                                            >
                                            <img height="100" width="100" class="rounded" src="<%= book.anh_bia %>"/>
                                            </a>
                                        </td>
                                        <td scope="col" class="text-wrap" ><%= book._id %></td>
                                        <td scope="col" class="text-wrap"><%= book.ten_dau_sach %></td>
                                        <td scope="col" class="text-wrap"><%= book.gia %></td>
                                        <td scope="col" class="text-wrap"><%= book.so_luong_kha_dung?"Còn sách":"Hết sách" %></td>
                                        <td>
                                            <button 
                                                class="btn btn-primary"
                                                id="add_<%=book._id%>"
                                                <%= book.so_luong_kha_dung?"":"disabled" %>
                                                onclick="addBook('<%= JSON.stringify({_id: book._id, anh_bia: book.anh_bia.split(`\\`).join(`\\\\`), ten_dau_sach: book.ten_dau_sach, gia: book.gia}) %>')"
                                            >
                                            Thêm
                                            </button>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } %>                 
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
</div>

